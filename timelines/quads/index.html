<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="user-scalable=no, width=device-width, initial-scale=1, maximum-scale=1">
  <script src="svg-pan-zoom.js"></script>
  <script src="hammer.js"></script>
  <style>
    html, body {
      margin: 0;
      padding: 0;
    }
    #mobile-div {
      width: 100%;
      height: 100vh;
    }
    svg {
      display: inline;
      width: inherit;
      min-width: inherit;
      max-width: inherit;
      height: inherit;
      min-height: inherit;
      max-height: inherit;
    }
  </style>
</head>

<body>
  <div id="mobile-div">
    <svg id="mobile-svg" xmlns="http://www.w3.org/2000/svg" version="1.1">
      <g visibility="hidden">
        <g id="tpl-grid" stroke="black" stroke-width="0.5" />
      </g>
      <g id="images"></g>
      <g id="grids"></g> <!-- NOTE Grid after images; grid drawn on top -->
    </svg>
  </div>

  <script>
    function archetypeGrid () {
      return '<line x1="0" y1="-1" x2="0" y2="1" vector-effect="non-scaling-stroke" />\n'
           + '<line x1="-1" y1="0" x2="1" y2="0" vector-effect="non-scaling-stroke" />\n'
    }

    function grid ({ scale, x = 0, y = 0 } = { scale: 1, x: 0, y: 0 }) {
      return `<use xlink:href="#tpl-grid" transform="translate(${x}, ${y}) scale(${scale})" />`
    }

    function gridz ({ scale, x = 0, y = 0 } = { scale: 1, x: 0, y: 0 }) {
      if (scale < 1) return ''
      let res = grid({ scale, x, y })
      scale *= 0.5
      res += gridz({ scale, x: x + scale, y: y + scale })
      return res
    }

    function image ({ href, x = 0, y = 0, width, height }) {
      // FIXME preserveAspectRatio="none" is a hack...
      return `<image href="${href}" x="${x}" y="${y}" height="${height}" width="${width}" preserveAspectRatio="none" />`
    }

    window.onload = function() {
      // init the grid achetype (or template)
      document.getElementById('tpl-grid').innerHTML = archetypeGrid()

      const scale = 1024
      const grids = document.getElementById('grids')
      grids.innerHTML += gridz({ scale })

      const data = [
        {
          name: 'Homo Sapiens',
          description: 'Mostly hunter gatherers, at least 90% of the time (number of individuals is a different story).',
          image: 'img/homo-sapiens-hunter-gatherers.png',
          start: '250 000 BP',
          end: null
        },
        {
          name: 'Homo Sapiens, Agriculture',
          image: 'img/homo-sapiens-agriculture.png',
          start: '12 000 BP',
          end: null
        }
      ]

      const factor = 32
      const images = document.getElementById('images')
      images.innerHTML += image({
        href: 'img/billions.jpg', // NOTE panorama-style image 2:1...
        // 2 000 000 BP - now
        width: factor * 64,
        height: factor * 64,
        x: factor * 32 - factor * 64,
        y: factor * 32 - factor * 64
      })
      images.innerHTML += image({
        href: 'img/mamals.png', // NOTE panorama-style image 2:1...
        // 2 000 000 BP - now
        width: factor * 16,
        height: factor * 16,
        x: factor * 32 - factor * 16,
        y: factor * 32 - factor * 16
      })

      images.innerHTML += image({
        href: 'img/homo-species.jpg', // NOTE panorama-style image 2:1...
        // 2 000 000 BP - now
        width: factor * 4,
        height: factor * 2,
        x: factor * 32 - factor * 4,
        y: factor * 32 - factor * 2
      })

      images.innerHTML += image({
        href: 'img/homo-sapiens-hunter-gatherers.png',
        // 250 000 BP - now
        width: factor / 1,
        height: factor / 1,
        x: factor * 32 - factor / 1,
        y: factor * 32 - factor / 1
      })

      //    16b     - TODO Make it this big!
      // 8b
      //    4b
      // 2b
      //    1b      - Billions & billions
      // 512m
      //    256m
      // 128m
      //    64m     - Mamals
      // 32m
      //    16m
      // 8m
      //    4m
      // 2m         - Homo
      //    1m
      // 500k
      //    250k    - Homo sapiens
      // 125k
      //    62.5k   - Cognitive revolution <-- TODO Add this (see Yuval Noah Harari)
      // 31.25k
      //    15.625k - Agriculture

      images.innerHTML += image({
        href: 'img/homo-sapiens-agriculture.png',
        start: '12 000 BP',
        // 15.625k is acceptable
        width: factor / 4, // 4k x 4k = 16k ...a but much, 8 - 12k BP is more like it
        height: factor / 4,
        x: factor * 32 - factor / 4,
        y: factor * 32 - factor / 4
       })

      var eventsHandler = {
        haltEventListeners: ['touchstart', 'touchend', 'touchmove', 'touchleave', 'touchcancel']
      , init: function(options) {
          var instance = options.instance
            , initialScale = 1
            , pannedX = 0
            , pannedY = 0

          // Init Hammer
          // Listen only for pointer and touch events
          this.hammer = Hammer(options.svgElement, {
            inputClass: Hammer.SUPPORT_POINTER_EVENTS ? Hammer.PointerEventInput : Hammer.TouchInput
          })

          // Enable pinch
          this.hammer.get('pinch').set({enable: true})

          // Handle double tap
          this.hammer.on('doubletap', function(ev){
            instance.zoomIn()
          })

          // Handle pan
          this.hammer.on('panstart panmove', function(ev){
            // On pan start reset panned variables
            if (ev.type === 'panstart') {
              pannedX = 0
              pannedY = 0
            }

            // Pan only the difference
            instance.panBy({x: ev.deltaX - pannedX, y: ev.deltaY - pannedY})
            pannedX = ev.deltaX
            pannedY = ev.deltaY
          })

          // Handle pinch
          this.hammer.on('pinchstart pinchmove', function(ev){
            // On pinch start remember initial zoom
            if (ev.type === 'pinchstart') {
              initialScale = instance.getZoom()
              instance.zoomAtPoint(initialScale * ev.scale, {x: ev.center.x, y: ev.center.y})
            }

            instance.zoomAtPoint(initialScale * ev.scale, {x: ev.center.x, y: ev.center.y})
          })

          // Prevent moving the page on some devices when panning over SVG
          options.svgElement.addEventListener('touchmove', function(e){ e.preventDefault(); });
        }

      , destroy: function(){
          this.hammer.destroy()
        }
      }

      // Expose to window namespace for testing purposes
      window.panZoom = svgPanZoom('#mobile-svg', {
        // zoomEnabled: true,
        // controlIconsEnabled: false,
        // fit: 1,
        // center: 1,
        zoomScaleSensitivity: 0.2,
        minZoom: 0.1,
        maxZoom: 2000000,
        customEventsHandler: eventsHandler
      });
    };
  </script>

</body>
</html>
