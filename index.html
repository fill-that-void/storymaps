<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="user-scalable=no, width=device-width, initial-scale=1, maximum-scale=1">
  <script src="svg-pan-zoom.js"></script>
  <script src="hammer.js"></script>
  <style>
    html, body {
      margin: 0;
      padding: 0;
    }
    #mobile-div {
      width: 100%;
      height: 100vh;
    }
    svg {
      display: inline;
      width: inherit;
      min-width: inherit;
      max-width: inherit;
      height: inherit;
      min-height: inherit;
      max-height: inherit;
    }
  </style>
</head>

<body>
  <div id="mobile-div">
    <svg id="mobile-svg" xmlns="http://www.w3.org/2000/svg" version="1.1">
      <g id="tpl-grid" stroke="black" stroke-width="0.25" />

      <g>
        <use xlink:href="#tpl-grid" transform="translate(0, 0) scale(0.03125)" />
        <use xlink:href="#tpl-grid" transform="translate(1, 1) scale(0.0009765625)" />
      </g>
    </svg>
  </div>

  <script>
    function grid () {
      let res = ''
      scale = 10
      const grid = { x: 32, y: 32 }
      for (let y = 0; y <= grid.y * scale; y += scale) {
        res += `<line x1="${0}" y1="${y}" x2="${grid.x * scale}" y2="${y}" />\n`
          // g.line(0, y, grid.x * scale, y)
        }
        for (let x = 0; x <= grid.x * scale; x += scale) {
        res += `<line x1="${x}" y1="${0}" x2="${x}" y2="${grid.y * scale}" />\n`
        // g.line(x, 0, x, grid.y * scale)
      }
      return res
    }

    window.onload = function() {
      const tpl = document.getElementById('tpl-grid')
      tpl.innerHTML = grid()
      // console.log(grid())
      // console.log({ grid })
      var eventsHandler;

      eventsHandler = {
        haltEventListeners: ['touchstart', 'touchend', 'touchmove', 'touchleave', 'touchcancel']
      , init: function(options) {
          var instance = options.instance
            , initialScale = 1
            , pannedX = 0
            , pannedY = 0

          // Init Hammer
          // Listen only for pointer and touch events
          this.hammer = Hammer(options.svgElement, {
            inputClass: Hammer.SUPPORT_POINTER_EVENTS ? Hammer.PointerEventInput : Hammer.TouchInput
          })

          // Enable pinch
          this.hammer.get('pinch').set({enable: true})

          // Handle double tap
          this.hammer.on('doubletap', function(ev){
            instance.zoomIn()
          })

          // Handle pan
          this.hammer.on('panstart panmove', function(ev){
            // On pan start reset panned variables
            if (ev.type === 'panstart') {
              pannedX = 0
              pannedY = 0
            }

            // Pan only the difference
            instance.panBy({x: ev.deltaX - pannedX, y: ev.deltaY - pannedY})
            pannedX = ev.deltaX
            pannedY = ev.deltaY
          })

          // Handle pinch
          this.hammer.on('pinchstart pinchmove', function(ev){
            // On pinch start remember initial zoom
            if (ev.type === 'pinchstart') {
              initialScale = instance.getZoom()
              instance.zoomAtPoint(initialScale * ev.scale, {x: ev.center.x, y: ev.center.y})
            }

            instance.zoomAtPoint(initialScale * ev.scale, {x: ev.center.x, y: ev.center.y})
          })

          // Prevent moving the page on some devices when panning over SVG
          options.svgElement.addEventListener('touchmove', function(e){ e.preventDefault(); });
        }

      , destroy: function(){
          this.hammer.destroy()
        }
      }

      // Expose to window namespace for testing purposes
      window.panZoom = svgPanZoom('#mobile-svg', {
        // zoomEnabled: true,
        // controlIconsEnabled: false,
        // fit: 1,
        // center: 1,
        zoomScaleSensitivity: 0.2,
        minZoom: 0.01,
        maxZoom: 10000,
        customEventsHandler: eventsHandler
      });
    };
  </script>

</body>
</html>
